<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery List</title>
</head>
<body>
    <h1>待送清單</h1>
    <table border="1">
        <thead>
            <tr>
                <th>訂單編號</th>
                <th>餐廳名稱</th>
                <th>送達地址</th>
                <th>金額</th>
                <th>狀態</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="delivery-table">
            <!-- JS will dynamically populate rows -->
        </tbody>
    </table>
    <script>
        async function fetchDeliveries() {
            const response = await fetch('/delivery/list');
            const deliveries = await response.json();
            const table = document.getElementById('delivery-table');
            table.innerHTML = '';
            deliveries.forEach(delivery => {
                const row = document.createElement('tr');
                const buttonLabel = delivery.status === '待取貨' ? '取貨' : '送達';
                const action = delivery.status === '待取貨' ? `pickupOrder(${delivery.Oid})` : `deliverOrder(${delivery.Oid})`;
                row.innerHTML = `
                    <td>${delivery.Oid}</td>
                    <td>${delivery.restaurant_name}</td>
                    <td>${delivery.delivery_address}</td>
                    <td>${delivery.amount}</td>
                    <td>${delivery.status}</td>
                    <td>
                        <button onclick="${action}">${buttonLabel}</button>
                        ${delivery.status === '送達中' ? '<input type="file" id="attachment-' + delivery.Oid + '">' : ''}
                    </td>
                `;
                table.appendChild(row);
            });
        }

        async function pickupOrder(orderId) {
            const response = await fetch('/delivery/pickup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ Oid: orderId })
            });
            if (response.ok) {
                alert('取貨成功！');
                fetchDeliveries();
            } else {
                alert('取貨失敗！');
            }
        }

        async function deliverOrder(orderId) {
            const attachment = document.getElementById(`attachment-${orderId}`).files[0];
            if (!attachment) {
                alert('請附上送達憑證！');
                return;
            }

            const formData = new FormData();
            formData.append('Oid', orderId);
            formData.append('attachment', attachment);

            const response = await fetch('/delivery/deliver', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('送達成功！');
                fetchDeliveries();
            } else {
                alert('送達失敗！');
            }
        }

        fetchDeliveries();
    </script>
</body>
</html>